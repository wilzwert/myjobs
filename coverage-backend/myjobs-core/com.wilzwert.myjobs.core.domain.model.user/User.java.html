<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>User.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">MyJobsAggregateReport</a> &gt; <a href="../index.html" class="el_bundle">myjobs-core</a> &gt; <a href="index.source.html" class="el_package">com.wilzwert.myjobs.core.domain.model.user</a> &gt; <span class="el_source">User.java</span></div><h1>User.java</h1><pre class="source lang-java linenums">package com.wilzwert.myjobs.core.domain.model.user;


import com.wilzwert.myjobs.core.domain.model.*;
import com.wilzwert.myjobs.core.domain.model.activity.Activity;
import com.wilzwert.myjobs.core.domain.model.activity.ActivityType;
import com.wilzwert.myjobs.core.domain.model.job.Job;
import com.wilzwert.myjobs.core.domain.model.job.JobId;
import com.wilzwert.myjobs.core.domain.model.job.command.UpdateJobFieldCommand;
import com.wilzwert.myjobs.core.domain.model.job.exception.JobAlreadyExistsException;
import com.wilzwert.myjobs.core.domain.model.job.exception.JobNotFoundException;
import com.wilzwert.myjobs.core.domain.model.user.exception.ResetPasswordExpiredException;
import com.wilzwert.myjobs.core.domain.model.user.exception.UserNotFoundException;
import com.wilzwert.myjobs.core.domain.shared.exception.ValidationException;
import com.wilzwert.myjobs.core.domain.shared.validation.*;

import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

/**
 * @author Wilhelm Zwertvaegher
 * TODO : use defensive copying on collections' getters to ensure immutability
 */
public class User extends DomainEntity&lt;UserId&gt; {

<span class="fc" id="L30">    public static final Integer DEFAULT_JOB_FOLLOW_UP_REMINDER_DAYS = 14;</span>
<span class="fc" id="L31">    public static final Lang DEFAULT_LANG = Lang.EN;</span>
    public static final String DEFAULT_ROLE = &quot;USER&quot;;

    private final UserId id;
    private final String email;
    private final EmailStatus emailStatus;
    private final String emailValidationCode;
    private final String password;
    private final String username;
    private final String firstName;
    private final String lastName;
    /**
     * Number of days after which a reminder should be triggered for jobs considered active
     * that haven't received any user interaction (e.g. no updates, status changes, or comments).
     * This helps ensure that jobs requiring attention are not forgotten.
     * Example: if set to 7, a reminder will be issued 7 days after the last action on the job.
     * Must be between 3 and 30, defaults to 14
     */
    private final Integer jobFollowUpReminderDays;
    private final Lang lang;
    private final String role;
    private final String resetPasswordToken;
    private final Instant resetPasswordExpiresAt;
    private final Instant createdAt;
    private final Instant updatedAt;
    private final Instant jobFollowUpReminderSentAt;
    private final List&lt;Job&gt; jobs;

    public static Builder builder() {
<span class="fc" id="L60">        return new Builder();</span>
    }

    /**
     * Warning : use only when sure user is a complete aggregate !
     * @param user the user we want to get a Builder from
     * @return the Builder
     */
    public static Builder from(User user) {
<span class="fc" id="L69">        return new Builder(user, true);</span>
    }

    /**
     * Warning : this is used to get a Builder allowing an incomplete aggregate
     * Use with great caution, as some methods on the aggregate won't work if it is not complete !
     * @param user the user we want to get a Builder from
     * @return the Builder
     */
    public static Builder fromMinimal(User user) {
<span class="fc" id="L79">        return new Builder(user, false);</span>
    }

    // Only for persistence mapping and tests. Do not use for new User creation!
    public static class Builder {
        private UserId id;
        private String email;
        private EmailStatus emailStatus;
        private String emailValidationCode;
        private String password;
        private String username;
        private String firstName;
        private String lastName;
        private Integer jobFollowUpReminderDays;
        private Lang lang;
        private String role;
        private String resetPasswordToken;
        private Instant resetPasswordExpiresAt;
        private Instant createdAt;
        private Instant updatedAt;
        private Instant jobFollowUpReminderSentAt;

<span class="fc" id="L101">        private List&lt;Job&gt; jobs = null;</span>

<span class="fc" id="L103">        public Builder() {}</span>

<span class="fc" id="L105">        private Builder(User user, boolean full) {</span>
<span class="fc" id="L106">            id = user.getId();</span>
<span class="fc" id="L107">            email = user.getEmail();</span>
<span class="fc" id="L108">            emailStatus = user.getEmailStatus();</span>
<span class="fc" id="L109">            emailValidationCode = user.getEmailValidationCode();</span>
<span class="fc" id="L110">            password = user.getPassword();</span>
<span class="fc" id="L111">            username = user.getUsername();</span>
<span class="fc" id="L112">            firstName = user.getFirstName();</span>
<span class="fc" id="L113">            lastName = user.getLastName();</span>
<span class="fc" id="L114">            jobFollowUpReminderDays = user.getJobFollowUpReminderDays();</span>
<span class="fc" id="L115">            lang = user.getLang();</span>
<span class="fc" id="L116">            role = user.getRole();</span>
<span class="fc" id="L117">            resetPasswordToken = user.getResetPasswordToken();</span>
<span class="fc" id="L118">            resetPasswordExpiresAt = user.getResetPasswordExpiresAt();</span>
<span class="fc" id="L119">            createdAt = user.getCreatedAt();</span>
<span class="fc" id="L120">            updatedAt = user.getUpdatedAt();</span>
<span class="fc" id="L121">            jobFollowUpReminderSentAt = user.getJobFollowUpReminderSentAt();</span>
<span class="fc bfc" id="L122" title="All 4 branches covered.">            jobs = full || user.jobs != null ? user.getJobs() : null;</span>
<span class="fc" id="L123">        }</span>

        public Builder id(UserId userId) {
<span class="fc" id="L126">            this.id = userId;</span>
<span class="fc" id="L127">            return this;</span>
        }

        public Builder email(String email) {
<span class="fc" id="L131">            this.email = email;</span>
<span class="fc" id="L132">            return this;</span>
        }

        public Builder emailStatus(EmailStatus emailStatus) {
<span class="fc" id="L136">            this.emailStatus = emailStatus;</span>
<span class="fc" id="L137">            return this;</span>
        }

        public Builder emailValidationCode(String emailValidationCode) {
<span class="fc" id="L141">            this.emailValidationCode = emailValidationCode;</span>
<span class="fc" id="L142">            return this;</span>
        }

        public Builder password(String password) {
<span class="fc" id="L146">            this.password = password;</span>
<span class="fc" id="L147">            return this;</span>
        }

        public Builder username(String username) {
<span class="fc" id="L151">            this.username = username;</span>
<span class="fc" id="L152">            return this;</span>
        }
        public Builder firstName(String firstName) {
<span class="fc" id="L155">            this.firstName = firstName;</span>
<span class="fc" id="L156">            return this;</span>
        }
        public Builder lastName(String lastName) {
<span class="fc" id="L159">            this.lastName = lastName;</span>
<span class="fc" id="L160">            return this;</span>
        }

        public Builder jobFollowUpReminderDays(Integer jobFollowUpReminderDays) {
<span class="fc" id="L164">            this.jobFollowUpReminderDays = jobFollowUpReminderDays;</span>
<span class="fc" id="L165">            return this;</span>
        }

        public Builder lang(Lang lang) {
<span class="fc" id="L169">            this.lang = lang;</span>
<span class="fc" id="L170">            return this;</span>
        }

        public Builder role(String role) {
<span class="fc" id="L174">            this.role = role;</span>
<span class="fc" id="L175">            return this;</span>
        }
        public Builder resetPasswordToken(String resetPasswordToken) {
<span class="fc" id="L178">            this.resetPasswordToken = resetPasswordToken;</span>
<span class="fc" id="L179">            return this;</span>
        }
        public Builder resetPasswordExpiresAt(Instant resetPasswordExpiresAt) {
<span class="fc" id="L182">            this.resetPasswordExpiresAt = resetPasswordExpiresAt;</span>
<span class="fc" id="L183">            return this;</span>
        }
        public Builder createdAt(Instant createdAt) {
<span class="fc" id="L186">            this.createdAt = createdAt;</span>
<span class="fc" id="L187">            return this;</span>
        }
        public Builder updatedAt(Instant updatedAt) {
<span class="fc" id="L190">            this.updatedAt = updatedAt;</span>
<span class="fc" id="L191">            return this;</span>
        }

        public Builder jobFollowUpReminderSentAt(Instant jobFollowUpReminderSentAt) {
<span class="fc" id="L195">            this.jobFollowUpReminderSentAt = jobFollowUpReminderSentAt;</span>
<span class="fc" id="L196">            return this;</span>
        }

        public Builder jobs(List&lt;Job&gt; jobs) {
<span class="fc" id="L200">            this.jobs = jobs;</span>
<span class="fc" id="L201">            return this;</span>
        }

        public User build() {
            // build User
<span class="fc" id="L206">            return new User(this);</span>
        }
    }

    private static ValidationError validatePassword(String plainPassword) {
<span class="fc" id="L211">        String regex = &quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[^\\w\\s]).+$&quot;;</span>
<span class="pc bpc" id="L212" title="2 of 6 branches missed.">        if(plainPassword == null || plainPassword.isEmpty() || !plainPassword.matches(regex)) {</span>
<span class="fc" id="L213">            return new ValidationError(&quot;password&quot;, ErrorCode.USER_WEAK_PASSWORD);</span>
        }
<span class="fc" id="L215">        return null;</span>
    }

    private ValidationErrors validate() {
<span class="fc" id="L219">        return new Validator()</span>
<span class="fc" id="L220">                .requireValidEmail(&quot;email&quot;, email)</span>
<span class="fc" id="L221">                .requireMinLength(&quot;username&quot;, username, 2)</span>
<span class="fc" id="L222">                .requireMaxLength(&quot;username&quot;, username, 30)</span>
<span class="fc" id="L223">                .requireNotEmpty(&quot;firstName&quot;, firstName)</span>
<span class="fc" id="L224">                .requireNotEmpty(&quot;lastName&quot;, lastName)</span>
<span class="fc" id="L225">                .requireMinIfNotNull(&quot;jobFollowUpReminderDays&quot;, jobFollowUpReminderDays, 3)</span>
<span class="fc" id="L226">                .requireMaxIfNotNull(&quot;jobFollowUpReminderDays&quot;, jobFollowUpReminderDays, 30)</span>
<span class="fc" id="L227">                .requireNotEmpty(&quot;role&quot;, role)</span>
<span class="fc" id="L228">                .requireNotEmpty(&quot;password&quot;, password)</span>
<span class="fc" id="L229">                .getErrors();</span>
    }

<span class="fc" id="L232">    private User(User.Builder builder) {</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">        this.id = builder.id != null ? builder.id : UserId.generate();</span>
<span class="fc" id="L234">        this.email = builder.email;</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">        this.emailValidationCode = builder.emailValidationCode != null ? builder.emailValidationCode : UUID.randomUUID().toString();</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">        this.emailStatus = builder.emailStatus != null ? builder.emailStatus : EmailStatus.PENDING;</span>
<span class="fc" id="L237">        this.password = builder.password;</span>
<span class="fc" id="L238">        this.username = builder.username;</span>
<span class="fc" id="L239">        this.firstName = builder.firstName;</span>
<span class="fc" id="L240">        this.lastName = builder.lastName;</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">        this.jobFollowUpReminderDays = builder.jobFollowUpReminderDays != null ? builder.jobFollowUpReminderDays : DEFAULT_JOB_FOLLOW_UP_REMINDER_DAYS;</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">        this.lang = builder.lang != null ? builder.lang : DEFAULT_LANG;</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">        this.role = builder.role != null ? builder.role : DEFAULT_ROLE;</span>
<span class="fc" id="L244">        this.resetPasswordToken = builder.resetPasswordToken;</span>
<span class="fc" id="L245">        this.resetPasswordExpiresAt = builder.resetPasswordExpiresAt;</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">        this.createdAt = builder.createdAt != null ? builder.createdAt : Instant.now();</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">        this.updatedAt = builder.updatedAt != null ? builder.updatedAt : Instant.now();</span>
<span class="fc" id="L248">        this.jobFollowUpReminderSentAt = builder.jobFollowUpReminderSentAt;</span>
        // jobs may be null in some cases, but it will throw an exception for operations that need them to be loaded
<span class="fc bfc" id="L250" title="All 2 branches covered.">        this.jobs = builder.jobs != null ? List.copyOf(builder.jobs) : null;</span>

        // validate the User state
<span class="fc" id="L253">        ValidationErrors validationErrors = validate();</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">        if(validationErrors.hasErrors()) {</span>
<span class="fc" id="L255">            throw new ValidationException(validationErrors);</span>
        }
<span class="fc" id="L257">    }</span>

    public Boolean isJobLate(Instant updatedAt) {
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        if(jobFollowUpReminderDays == null) {</span>
<span class="nc" id="L261">            return false;</span>
        }
<span class="fc" id="L263">        Instant maxInstant = Instant.now().minusSeconds((long) jobFollowUpReminderDays * 86_400);</span>
<span class="fc" id="L264">        return updatedAt.isBefore(maxInstant);</span>
    }

    private void requireFull() {
<span class="fc" id="L268">        requireLoadedProperty(jobs);</span>
<span class="fc" id="L269">    }</span>

    private User copy(List&lt;Job&gt; jobs) {

<span class="fc" id="L273">        return new User(</span>
<span class="fc" id="L274">                from(this)</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">                    .jobs(jobs != null ? jobs : getJobs())</span>
        );
    }

    public static User create(User.Builder builder, String plainPassword) {
<span class="fc" id="L280">        ValidationErrors errors = new ValidationErrors();</span>
<span class="fc" id="L281">        User createdUser = null;</span>
        try {
<span class="fc" id="L283">            createdUser = new User(builder);</span>
        }
<span class="fc" id="L285">        catch(ValidationException e) {</span>
<span class="fc" id="L286">            errors.merge(e.getErrors());</span>
<span class="fc" id="L287">        }</span>

        // password strength validation is very specific and belongs to the user
<span class="fc" id="L290">        ValidationError error = validatePassword(plainPassword);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">        if(error != null) {</span>
<span class="fc" id="L292">            errors.add(error);</span>
        }

<span class="fc bfc" id="L295" title="All 2 branches covered.">        if(errors.hasErrors()) {</span>
<span class="fc" id="L296">            throw new ValidationException(errors);</span>
        }

<span class="fc" id="L299">        return createdUser;</span>
    }

    public User update(String email, String username, String firstName, String lastName, Integer jobFollowUpReminderDays) {

        // if email changed we have to change its status
<span class="fc" id="L305">        EmailStatus newEmailStatus = getEmailStatus();</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">        if(!email.equals(getEmail())) {</span>
<span class="fc" id="L307">            newEmailStatus = EmailStatus.PENDING;</span>
        }

<span class="fc" id="L310">        return new User(</span>
<span class="fc" id="L311">                fromMinimal(this)</span>
<span class="fc" id="L312">                        .email(email)</span>
<span class="fc" id="L313">                        .emailStatus(newEmailStatus)</span>
<span class="fc" id="L314">                        .username(username)</span>
<span class="fc" id="L315">                        .firstName(firstName)</span>
<span class="fc" id="L316">                        .lastName(lastName)</span>
<span class="fc" id="L317">                        .jobFollowUpReminderDays(jobFollowUpReminderDays)</span>
<span class="fc" id="L318">                        .updatedAt(Instant.now())</span>
        );
    }

    public User addJob(Job job) {
<span class="fc" id="L323">        requireFull();</span>

        // check if job to be added already exists by its url
<span class="fc" id="L326">        jobs.stream().filter(j -&gt; j.getUrl().equals(job.getUrl())).findAny().ifPresent(found -&gt; {throw new JobAlreadyExistsException();});</span>

<span class="fc" id="L328">        List&lt;Job&gt; newJobs = new ArrayList&lt;&gt;(jobs);</span>

        // automatically create first activity
<span class="fc" id="L331">        newJobs.add(job.addActivity(Activity.builder().type(ActivityType.CREATION).build()));</span>

<span class="fc" id="L333">        return copy(newJobs);</span>
    }

    public Optional&lt;Job&gt; getJobById(JobId jobId) {
<span class="fc" id="L337">        return getJobs().stream().filter(j -&gt; j.getId().equals(jobId)).findFirst();</span>
    }

    public Optional&lt;Job&gt; getJobByUrl(String url) {
<span class="fc" id="L341">        return getJobs().stream().filter(j -&gt; j.getUrl().equals(url)).findFirst();</span>
    }

    public User updateJobField(Job job, UpdateJobFieldCommand.Field field, String value) {
<span class="fc" id="L345">        requireFull();</span>

<span class="pc bpc" id="L347" title="1 of 2 branches missed.">        if(!jobs.contains(job)) {</span>
<span class="nc" id="L348">            throw new JobNotFoundException();</span>
        }

<span class="pc bpc" id="L351" title="1 of 4 branches missed.">        if(field.equals(UpdateJobFieldCommand.Field.URL) &amp;&amp; !value.equals(job.getUrl())) {</span>
<span class="fc" id="L352">            jobs.stream().filter(j -&gt; j.getUrl().equals(value)).findAny().ifPresent(found -&gt; {throw new JobAlreadyExistsException();});</span>
        }

<span class="fc" id="L355">        int index = jobs.indexOf(job);</span>
<span class="fc" id="L356">        Job.Builder builder = Job.from(job).updatedAt(Instant.now());</span>

<span class="pc bpc" id="L358" title="6 of 8 branches missed.">        switch(field) {</span>
<span class="fc" id="L359">            case TITLE -&gt; builder.title(value);</span>
<span class="fc" id="L360">            case URL -&gt; builder.url(value);</span>
<span class="nc" id="L361">            case DESCRIPTION -&gt; builder.description(value);</span>
<span class="nc" id="L362">            case PROFILE -&gt; builder.profile(value);</span>
<span class="nc" id="L363">            case SALARY -&gt; builder.salary(value);</span>
<span class="nc" id="L364">            case COMMENT -&gt; builder.comment(value);</span>
<span class="nc" id="L365">            case COMPANY -&gt; builder.company(value);</span>
        }

<span class="fc" id="L368">        List&lt;Job&gt; newJobs = new ArrayList&lt;&gt;(jobs);</span>
<span class="fc" id="L369">        newJobs.set(index, builder.build());</span>
<span class="fc" id="L370">        return copy(newJobs);</span>
    }

    public User updateJob(Job job, String url, String title, String company, String description, String profile, String comment, String salary) {
<span class="fc" id="L374">        requireFull();</span>

<span class="pc bpc" id="L376" title="1 of 2 branches missed.">        if(!jobs.contains(job)) {</span>
<span class="nc" id="L377">            throw new JobNotFoundException();</span>
        }
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">        if(!url.equals(job.getUrl())) {</span>
<span class="fc" id="L380">            jobs.stream().filter(j -&gt; j.getUrl().equals(url)).findAny().ifPresent(found -&gt; {throw new JobAlreadyExistsException();});</span>
        }

<span class="fc" id="L383">        int index = jobs.indexOf(job);</span>

<span class="fc" id="L385">        List&lt;Job&gt; newJobs = new ArrayList&lt;&gt;(jobs);</span>
<span class="fc" id="L386">        newJobs.set(index,</span>
<span class="fc" id="L387">                Job.from(job)</span>
<span class="fc" id="L388">                    .url(url)</span>
<span class="fc" id="L389">                    .title(title)</span>
<span class="fc" id="L390">                    .company(company)</span>
<span class="fc" id="L391">                    .description(description)</span>
<span class="fc" id="L392">                    .profile(profile)</span>
<span class="fc" id="L393">                    .comment(comment)</span>
<span class="fc" id="L394">                    .salary(salary)</span>
<span class="fc" id="L395">                    .updatedAt(Instant.now())</span>
<span class="fc" id="L396">                    .build()</span>
        );

<span class="fc" id="L399">        return copy(newJobs);</span>
    }

    public User removeJob(Job job) {
<span class="fc" id="L403">        requireFull();</span>

<span class="pc bpc" id="L405" title="1 of 2 branches missed.">        if(!jobs.contains(job)) {</span>
<span class="nc" id="L406">            throw new JobNotFoundException();</span>
        }
<span class="fc" id="L408">        List&lt;Job&gt; newJobs = new ArrayList&lt;&gt;(jobs);</span>
<span class="fc" id="L409">        newJobs.remove(job);</span>
<span class="fc" id="L410">        return copy(newJobs);</span>
    }

    /**
     * Used to complete the aggregate with its required properties
     * As of now, the only property needed to be complete, and which may not be loaded, is jobs
     * This may be used when an incomplete User is loaded, and you want to make it complete and coherent
     * and do stuff on it
     * @param jobsList the user's jobs list
     * @return a complete User aggregate
     */
    public User completeWith(List&lt;Job&gt; jobsList) {
<span class="fc" id="L422">        requireLoadedProperty(jobsList);</span>

<span class="fc" id="L424">        return new User(</span>
<span class="fc" id="L425">            fromMinimal(this)</span>
<span class="fc" id="L426">                .jobs(jobsList)</span>
        );
    }

    public User updatePassword(String plainPassword, String newPassword) {
<span class="fc" id="L431">        ValidationErrors errors = new ValidationErrors();</span>
<span class="fc" id="L432">        User updatedUser = null;</span>
        try {
<span class="fc" id="L434">            updatedUser = new User(</span>
<span class="fc" id="L435">                from(this)</span>
<span class="fc" id="L436">                    .password(newPassword)</span>
            );
        }
<span class="nc" id="L439">        catch(ValidationException e) {</span>
<span class="nc" id="L440">            errors.merge(e.getErrors());</span>
<span class="fc" id="L441">        }</span>

        // password strength validation is very specific and belongs to the user
<span class="fc" id="L444">        ValidationError error = validatePassword(plainPassword);</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">        if(error != null) {</span>
<span class="fc" id="L446">            errors.add(error);</span>
        }

<span class="fc bfc" id="L449" title="All 2 branches covered.">        if(errors.hasErrors()) {</span>
<span class="fc" id="L450">            throw new ValidationException(errors);</span>
        }

<span class="fc" id="L453">        return updatedUser;</span>
    }

    public User resetPassword() {
        // a reset password request just overrides all previous ones
<span class="fc" id="L458">        return new User(</span>
<span class="fc" id="L459">                from(this)</span>
                    // FIXME : maybe we should use a value object with a generator
<span class="fc" id="L461">                    .resetPasswordToken(UUID.randomUUID().toString())</span>
                    // FIXME : duration should not be hard coded this way
                    // it should be handled by domain anyway
<span class="fc" id="L464">                    .resetPasswordExpiresAt(Instant.now().plus(30, ChronoUnit.MINUTES))</span>
        );
    }

    public User createNewPassword(String plainPassword, String newPassword) {
<span class="fc bfc" id="L469" title="All 2 branches covered.">        if(resetPasswordExpiresAt.isBefore(Instant.now())) {</span>
<span class="fc" id="L470">            throw new ResetPasswordExpiredException();</span>
        }

<span class="fc" id="L473">        return updatePassword(plainPassword, newPassword);</span>
    }

    public User validateEmail(String emailValidationCode) {
<span class="pc bpc" id="L477" title="2 of 4 branches missed.">        if (getEmailValidationCode() == null || !getEmailValidationCode().equals(emailValidationCode)) {</span>
<span class="nc" id="L478">            throw new UserNotFoundException();</span>
        }

<span class="pc bpc" id="L481" title="1 of 2 branches missed.">        if(getEmailStatus().equals(EmailStatus.VALIDATED)) {</span>
<span class="nc" id="L482">            return this;</span>
        }

<span class="fc" id="L485">        return new User(</span>
<span class="fc" id="L486">            fromMinimal(this)</span>
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">                .emailStatus(getEmailStatus().equals(EmailStatus.PENDING) ? EmailStatus.VALIDATED : getEmailStatus())</span>
        );
    }

    public User updateLang(Lang lang) {
<span class="fc" id="L492">        return new User(</span>
<span class="fc" id="L493">            fromMinimal(this)</span>
<span class="fc" id="L494">                .lang(lang)</span>
        );
    }

    public User saveJobFollowUpReminderSentAt() {
<span class="fc" id="L499">        return new User(</span>
<span class="fc" id="L500">            fromMinimal(this)</span>
<span class="fc" id="L501">                .jobFollowUpReminderSentAt(Instant.now())</span>
        );
    }

    public UserId getId() {
<span class="fc" id="L506">        return id;</span>
    }

    public String getEmail() {
<span class="fc" id="L510">        return email;</span>
    }

    public EmailStatus getEmailStatus() {
<span class="fc" id="L514">        return emailStatus;</span>
    }

    public String getEmailValidationCode() {
<span class="fc" id="L518">        return emailValidationCode;</span>
    }

    public String getPassword() {
<span class="fc" id="L522">        return password;</span>
    }

    public String getUsername() {
<span class="fc" id="L526">        return username;</span>
    }

    public String getFirstName() {
<span class="fc" id="L530">        return firstName;</span>
    }

    public String getLastName() {
<span class="fc" id="L534">        return lastName;</span>
    }

<span class="fc" id="L537">    public Integer getJobFollowUpReminderDays() { return jobFollowUpReminderDays; }</span>

<span class="fc" id="L539">    public Lang getLang() { return lang; }</span>

    public String getRole() {
<span class="fc" id="L542">        return role;</span>
    }

<span class="fc" id="L545">    public String  getResetPasswordToken() {return resetPasswordToken;}</span>

<span class="fc" id="L547">    public Instant getResetPasswordExpiresAt() {return resetPasswordExpiresAt;}</span>

    public Instant getCreatedAt() {
<span class="fc" id="L550">        return createdAt;</span>
    }

    public Instant getUpdatedAt() {
<span class="fc" id="L554">        return updatedAt;</span>
    }

<span class="fc" id="L557">    public Instant getJobFollowUpReminderSentAt() {return jobFollowUpReminderSentAt;}</span>

    public List&lt;Job&gt; getJobs() {
<span class="fc" id="L560">        requireLoadedProperty(jobs);</span>
<span class="fc" id="L561">        return jobs;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L566">        return getId().toString()+ &quot; [email=&quot;+getEmail() + &quot;]&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>