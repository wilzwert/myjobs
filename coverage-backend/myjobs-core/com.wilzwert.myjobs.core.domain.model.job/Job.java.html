<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Job.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">MyJobsAggregateReport</a> &gt; <a href="../index.html" class="el_bundle">myjobs-core</a> &gt; <a href="index.source.html" class="el_package">com.wilzwert.myjobs.core.domain.model.job</a> &gt; <span class="el_source">Job.java</span></div><h1>Job.java</h1><pre class="source lang-java linenums">package com.wilzwert.myjobs.core.domain.model.job;

import com.wilzwert.myjobs.core.domain.model.activity.exception.ActivityNotFoundException;
import com.wilzwert.myjobs.core.domain.shared.exception.ValidationException;
import com.wilzwert.myjobs.core.domain.model.activity.Activity;
import com.wilzwert.myjobs.core.domain.model.activity.ActivityType;
import com.wilzwert.myjobs.core.domain.model.attachment.Attachment;
import com.wilzwert.myjobs.core.domain.model.DomainEntity;
import com.wilzwert.myjobs.core.domain.model.user.UserId;
import com.wilzwert.myjobs.core.domain.shared.validation.ValidationErrors;
import com.wilzwert.myjobs.core.domain.shared.validation.Validator;

import java.time.Instant;
import java.util.*;

/**
 * @author Wilhelm Zwertvaegher
 */
public class Job extends DomainEntity&lt;JobId&gt; {
    private final JobId id;

    private final String url;

    private final JobStatus status;

    private final String title;

    private final String company;

    private final String description;

    private final String profile;

    private final String comment;

    private final String salary;

    private final JobRating rating;

    private final Instant createdAt;

    private final Instant updatedAt;

    private final Instant statusUpdatedAt;

    private final Instant followUpReminderSentAt;

    private final UserId userId;

    private final List&lt;Activity&gt; activities;

    private final List&lt;Attachment&gt; attachments;

<span class="fc" id="L54">    private static final Map&lt;ActivityType, JobStatus&gt; activityToStatus = Map.of(</span>
        ActivityType.APPLICATION, JobStatus.PENDING,
        ActivityType.APPLICANT_REFUSAL, JobStatus.APPLICANT_REFUSED,
        ActivityType.COMPANY_REFUSAL, JobStatus.COMPANY_REFUSED,
        ActivityType.RELAUNCH, JobStatus.RELAUNCHED
    );

    public static Builder builder() {
<span class="fc" id="L62">        return new Builder();</span>
    }

    public static Builder from(Job job) {
<span class="fc" id="L66">        return new Builder(job, true);</span>
    }

    /**
     * Warning : this is used to get a Builder allowing an incomplete aggregate
     * Use with great caution, as some methods on the aggregate won't work if it is not complete !
     * @param job the job we want to get a Builder from
     * @return the Builder
     */
    public static Builder fromMinimal(Job job) {
<span class="fc" id="L76">        return new Job.Builder(job, false);</span>
    }

    public static class Builder {
        private JobId id;

        private String url;

        private JobStatus status;

        private String title;

        private String company;

        private String description;

        private String profile;

        private String comment;

        private String salary;

        private JobRating rating;

        private Instant createdAt;

        private Instant updatedAt;

        private Instant statusUpdatedAt;

        private Instant followUpReminderSentAt;

        private UserId userId;

        private List&lt;Activity&gt; activities;

        private List&lt;Attachment&gt; attachments;

<span class="fc" id="L114">        public Builder() {</span>
<span class="fc" id="L115">        }</span>

<span class="fc" id="L117">        public Builder(Job job, boolean full) {</span>
<span class="fc" id="L118">            this.id = job.getId();</span>
<span class="fc" id="L119">            this.url = job.getUrl();</span>
<span class="fc" id="L120">            this.status = job.getStatus();</span>
<span class="fc" id="L121">            this.title = job.getTitle();</span>
<span class="fc" id="L122">            this.company = job.getCompany();</span>
<span class="fc" id="L123">            this.description = job.getDescription();</span>
<span class="fc" id="L124">            this.profile = job.getProfile();</span>
<span class="fc" id="L125">            this.comment = job.getComment();</span>
<span class="fc" id="L126">            this.salary = job.getSalary();</span>
<span class="fc" id="L127">            this.rating = job.getRating();</span>
<span class="fc" id="L128">            this.createdAt = job.getCreatedAt();</span>
<span class="fc" id="L129">            this.updatedAt = job.getUpdatedAt();</span>
<span class="fc" id="L130">            this.statusUpdatedAt = job.getStatusUpdatedAt();</span>
<span class="fc" id="L131">            this.followUpReminderSentAt = job.getFollowUpReminderSentAt();</span>
<span class="fc" id="L132">            this.userId = job.getUserId();</span>
<span class="pc bpc" id="L133" title="1 of 4 branches missed.">            this.activities = full || job.activities != null ? job.getActivities() : null;</span>
<span class="pc bpc" id="L134" title="1 of 4 branches missed.">            this.attachments = full || job.attachments != null ? job.getAttachments() : null;</span>
<span class="fc" id="L135">        }</span>

        public Builder id(JobId id) {
<span class="fc" id="L138">            this.id = id;</span>
<span class="fc" id="L139">            return this;</span>
        }

        public Builder url(String url) {
<span class="fc" id="L143">            this.url = url;</span>
<span class="fc" id="L144">            return this;</span>
        }

        public Builder status(JobStatus status) {
<span class="fc" id="L148">            this.status = status;</span>
<span class="fc" id="L149">            return this;</span>
        }

        public Builder title(String title) {
<span class="fc" id="L153">            this.title = title;</span>
<span class="fc" id="L154">            return this;</span>
        }

        public Builder company(String company) {
<span class="fc" id="L158">            this.company = company;</span>
<span class="fc" id="L159">            return this;</span>
        }

        public Builder description(String description) {
<span class="fc" id="L163">            this.description = description;</span>
<span class="fc" id="L164">            return this;</span>
        }

        public Builder profile(String profile) {
<span class="fc" id="L168">            this.profile = profile;</span>
<span class="fc" id="L169">            return this;</span>
        }

        public Builder comment(String comment) {
<span class="fc" id="L173">            this.comment = comment;</span>
<span class="fc" id="L174">            return this;</span>
        }

        public Builder salary(String salary) {
<span class="fc" id="L178">            this.salary = salary;</span>
<span class="fc" id="L179">            return this;</span>
        }

        public Builder rating(JobRating rating) {
<span class="fc" id="L183">            this.rating = rating;</span>
<span class="fc" id="L184">            return this;</span>
        }

        public Builder createdAt(Instant createdAt) {
<span class="fc" id="L188">            this.createdAt = createdAt;</span>
<span class="fc" id="L189">            return this;</span>
        }

        public Builder updatedAt(Instant updatedAt) {
<span class="fc" id="L193">            this.updatedAt = updatedAt;</span>
<span class="fc" id="L194">            return this;</span>
        }

        public Builder statusUpdatedAt(Instant updatedAt) {
<span class="fc" id="L198">            this.statusUpdatedAt = updatedAt;</span>
<span class="fc" id="L199">            return this;</span>
        }

        public Builder followUpReminderSentAt(Instant followUpReminderSentAt) {
<span class="fc" id="L203">            this.followUpReminderSentAt = followUpReminderSentAt;</span>
<span class="fc" id="L204">            return this;</span>
        }

        public Builder userId(UserId userId) {
<span class="fc" id="L208">            this.userId = userId;</span>
<span class="fc" id="L209">            return this;</span>
        }

        public Builder activities(List&lt;Activity&gt; activities) {
<span class="fc" id="L213">            this.activities = activities;</span>
<span class="fc" id="L214">            return this;</span>
        }

        public Builder attachments(List&lt;Attachment&gt; attachments) {
<span class="fc" id="L218">            this.attachments = attachments;</span>
<span class="fc" id="L219">            return this;</span>
        }

        public Job build() {
<span class="fc" id="L223">            return new Job(this);</span>
        }
    }

    private ValidationErrors validate() {
<span class="fc" id="L228">        return  new Validator()</span>
<span class="fc" id="L229">                .requireNotEmpty(&quot;id&quot;, id)</span>
<span class="fc" id="L230">                .requireNotEmpty(&quot;userId&quot;, userId)</span>
<span class="fc" id="L231">                .requireNotEmpty(&quot;title&quot;, title)</span>
<span class="fc" id="L232">                .requireNotEmpty(&quot;description&quot;, description)</span>
<span class="fc" id="L233">                .requireNotEmpty(&quot;company&quot;, company)</span>
<span class="fc" id="L234">                .requireValidUrl(&quot;url&quot;, url)</span>
<span class="fc" id="L235">                .getErrors();</span>
    }

<span class="fc" id="L238">    private Job(Builder builder) {</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">        this.id = builder.id != null ? builder.id : JobId.generate();</span>
<span class="fc" id="L240">        this.url = builder.url;</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">        this.status = builder.status != null ? builder.status : JobStatus.CREATED;</span>
<span class="fc" id="L242">        this.title = builder.title;</span>
<span class="fc" id="L243">        this.company = builder.company;</span>
<span class="fc" id="L244">        this.description = builder.description;</span>
<span class="fc" id="L245">        this.profile = builder.profile;</span>
<span class="fc" id="L246">        this.comment = builder.comment;</span>
<span class="fc" id="L247">        this.salary = builder.salary;</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">        this.rating = builder.rating != null ? builder.rating : JobRating.of(0);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">        this.createdAt = builder.createdAt != null ? builder.createdAt : Instant.now();</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">        this.updatedAt = builder.updatedAt != null ? builder.updatedAt : Instant.now();</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">        this.statusUpdatedAt = builder.statusUpdatedAt != null ? builder.statusUpdatedAt : Instant.now();</span>
<span class="fc" id="L252">        this.followUpReminderSentAt = builder.followUpReminderSentAt;</span>
<span class="fc" id="L253">        this.userId = builder.userId;</span>

        // ensure immutability
        // null is accepted because in some cases we allow working on aggregates that could be &quot;incomplete&quot;
<span class="fc bfc" id="L257" title="All 2 branches covered.">        this.activities = builder.activities != null ? List.copyOf(builder.activities) : null;</span>
        // ensure immutability
        // null is accepted because in some cases we allow working on aggregates that could be &quot;incomplete&quot;
<span class="fc bfc" id="L260" title="All 2 branches covered.">        this.attachments = builder.attachments != null ? List.copyOf(builder.attachments) : null;</span>

<span class="fc" id="L262">        ValidationErrors validationErrors = validate();</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">        if(validationErrors.hasErrors()) {</span>
<span class="fc" id="L264">            throw new ValidationException(validationErrors);</span>
        }
<span class="fc" id="L266">    }</span>

    public static Job create(Job.Builder builder) {
<span class="fc" id="L269">        builder.attachments(Collections.emptyList()).activities(Collections.emptyList());</span>
<span class="fc" id="L270">        return new Job(builder);</span>
    }

    private void requireFull() {
<span class="fc" id="L274">        requireLoadedProperty(attachments);</span>
<span class="fc" id="L275">        requireLoadedProperty(activities);</span>
<span class="fc" id="L276">    }</span>

    private Job copy(List&lt;Attachment&gt; attachments, List&lt;Activity&gt; activities, JobStatus status, Instant updatedAt) {
<span class="fc" id="L279">        Instant newStatusUpdatedAt = getStatusUpdatedAt();</span>
<span class="fc bfc" id="L280" title="All 4 branches covered.">        if( status != null &amp;&amp; !status.equals(getStatus())) {</span>
            // set statusUpdatedAt
<span class="fc" id="L282">            newStatusUpdatedAt = Instant.now();</span>
        }

<span class="fc" id="L285">        return new Job(</span>
<span class="fc" id="L286">            from(this)</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">                .status(status != null ? status : getStatus())</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">                .updatedAt(updatedAt != null ? updatedAt : getUpdatedAt())</span>
<span class="fc" id="L289">                .statusUpdatedAt(newStatusUpdatedAt)</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">                .activities(activities != null ? activities : getActivities())</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">                .attachments(attachments != null ? attachments : getAttachments())</span>
        );
    }
    public Job addActivity(Activity activity) {
<span class="fc" id="L295">        requireFull();</span>

<span class="fc" id="L297">        JobStatus newJobStatus = activityToStatus.get(activity.getType());</span>
<span class="fc" id="L298">        var updatedActivities = new ArrayList&lt;&gt;(getActivities());</span>
<span class="fc" id="L299">        updatedActivities.add(activity);</span>
<span class="fc" id="L300">        updatedActivities.sort(Comparator.comparing(Activity::getCreatedAt).reversed());</span>
<span class="fc" id="L301">        return copy(null, updatedActivities, newJobStatus, Instant.now());</span>
    }

    public Job updateActivity(Activity activity) {
<span class="fc" id="L305">        requireFull();</span>

<span class="fc" id="L307">        Activity oldActivity = activities.stream().filter(a -&gt; a.equals(activity)).findFirst().orElseThrow(ActivityNotFoundException::new);</span>

<span class="fc" id="L309">        JobStatus newJobStatus = activityToStatus.get(activity.getType());</span>

        // create new activity based on the old one and the activity passed
<span class="fc" id="L312">        Activity updateActivity = Activity.from(oldActivity)</span>
<span class="fc" id="L313">                .updatedAt(Instant.now())</span>
<span class="fc" id="L314">                .type(activity.getType())</span>
<span class="fc" id="L315">                .comment(activity.getComment())</span>
<span class="fc" id="L316">                .build();</span>

        // update activities list
<span class="fc" id="L319">        var updatedActivities = new ArrayList&lt;&gt;(getActivities());</span>
<span class="fc" id="L320">        updatedActivities.remove(oldActivity);</span>
<span class="fc" id="L321">        updatedActivities.add(updateActivity);</span>
<span class="fc" id="L322">        updatedActivities.sort(Comparator.comparing(Activity::getCreatedAt).thenComparing(Activity::getUpdatedAt).reversed());</span>

        // return a copy of this job with updated data
<span class="fc" id="L325">        return copy(null, updatedActivities, newJobStatus, Instant.now());</span>
    }

    public Job addAttachment(Attachment attachment) {
<span class="fc" id="L329">        requireFull();</span>
<span class="fc" id="L330">        var updatedAttachments = new ArrayList&lt;&gt;(getAttachments());</span>
<span class="fc" id="L331">        updatedAttachments.add(attachment);</span>
<span class="fc" id="L332">        updatedAttachments.sort(Comparator.comparing(Attachment::getCreatedAt).reversed());</span>
<span class="fc" id="L333">        return copy(updatedAttachments, null, null, Instant.now());</span>
    }

    public Job removeAttachment(Attachment attachment) {
<span class="fc" id="L337">        requireFull();</span>
<span class="fc" id="L338">        var updatedAttachments = new ArrayList&lt;&gt;(getAttachments());</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">        if(!updatedAttachments.contains(attachment)) {</span>
<span class="nc" id="L340">            throw new IllegalArgumentException(&quot;Attachment not in list&quot;);</span>
        }

<span class="fc" id="L343">        updatedAttachments.remove(attachment);</span>
<span class="fc" id="L344">        return copy(updatedAttachments, null, null, Instant.now());</span>
    }

    public Job updateStatus(JobStatus newStatus) {
<span class="fc bfc" id="L348" title="All 2 branches covered.">        if(this.status == newStatus) return this;</span>

<span class="fc" id="L350">        requireFull();</span>

        Job result;
<span class="fc" id="L353">        ActivityType activityType = activityToStatus.entrySet().stream().filter(entry -&gt; newStatus.equals(entry.getValue())).map(Map.Entry::getKey).findFirst().orElse(null);</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">        Activity activity = !activities.isEmpty() ? activities.getLast() : null;</span>
<span class="pc bpc" id="L355" title="2 of 6 branches missed.">        if(activityType != null &amp;&amp; (activity == null || !activity.getType().equals(activityType))) {</span>
            // create activity
<span class="fc" id="L357">            Activity newActivity = Activity.builder().type(activityType).build();</span>
<span class="fc" id="L358">            result = addActivity(newActivity);</span>
<span class="fc" id="L359">        }</span>
        else {
<span class="nc" id="L361">            result = this;</span>
        }

<span class="fc" id="L364">        return result.copy(null, result.getActivities(), newStatus, Instant.now());</span>
    }

    public Job updateRating(JobRating newJobRating) {
<span class="fc bfc" id="L368" title="All 2 branches covered.">        if(newJobRating.equals(getRating())) return this;</span>

<span class="fc" id="L370">        requireFull();</span>

<span class="fc" id="L372">        Job result = new Job(</span>
<span class="fc" id="L373">            from(this)</span>
<span class="fc" id="L374">                .rating(newJobRating)</span>
<span class="fc" id="L375">                .updatedAt(Instant.now())</span>
        );
<span class="fc" id="L377">        Activity newActivity = Activity.builder().type(ActivityType.RATING).comment(&quot;&quot;+newJobRating.getValue()).build();</span>
<span class="fc" id="L378">        return result.addActivity(newActivity);</span>
    }

    public Job saveFollowUpReminderSentAt() {
<span class="fc" id="L382">        return new Job(</span>
<span class="fc" id="L383">            from(this)</span>
<span class="fc" id="L384">                .followUpReminderSentAt(Instant.now())</span>
        );
    }

    public JobId getId() {
<span class="fc" id="L389">        return id;</span>
    }

    public String getUrl() {
<span class="fc" id="L393">        return url;</span>
    }

    public JobStatus getStatus() {
<span class="fc" id="L397">        return status;</span>
    }

    public String getTitle() {
<span class="fc" id="L401">        return title;</span>
    }

    public String getCompany() {
<span class="fc" id="L405">        return company;</span>
    }

    public String getDescription() {
<span class="fc" id="L409">        return description;</span>
    }

    public String getProfile() {
<span class="fc" id="L413">        return profile;</span>
    }

<span class="fc" id="L416">    public String getComment() { return comment; }</span>

<span class="fc" id="L418">    public String getSalary() { return salary; }</span>

    public JobRating getRating() {
<span class="fc" id="L421">        return rating;</span>
    }

<span class="fc" id="L424">    public Instant getCreatedAt() {return createdAt;}</span>

    public Instant getUpdatedAt() {
<span class="fc" id="L427">        return updatedAt;</span>
    }

    public Instant getStatusUpdatedAt() {
<span class="fc" id="L431">        return statusUpdatedAt;</span>
    }

<span class="fc" id="L434">    public Instant getFollowUpReminderSentAt() { return followUpReminderSentAt; }</span>

    public UserId getUserId() {
<span class="fc" id="L437">        return userId;</span>
    }

    public List&lt;Activity&gt; getActivities() {
<span class="fc" id="L441">        return activities;</span>
    }
    public List&lt;Attachment&gt; getAttachments() {
<span class="fc" id="L444">        return attachments;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L449">        return getId().toString()+ &quot; [userId=&quot;+getUserId().toString()+&quot;,title=&quot;+getTitle() + &quot;]&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>