<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DomainSpecificationConverter.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">MyJobsAggregateReport</a> &gt; <a href="../index.html" class="el_bundle">myjobs-infrastructure</a> &gt; <a href="index.source.html" class="el_package">com.wilzwert.myjobs.infrastructure.persistence.mongo.service</a> &gt; <span class="el_source">DomainSpecificationConverter.java</span></div><h1>DomainSpecificationConverter.java</h1><pre class="source lang-java linenums">package com.wilzwert.myjobs.infrastructure.persistence.mongo.service;

import com.wilzwert.myjobs.core.domain.model.job.JobId;
import com.wilzwert.myjobs.core.domain.model.job.JobStatus;
import com.wilzwert.myjobs.core.domain.model.user.UserId;
import com.wilzwert.myjobs.core.domain.shared.specification.DomainSpecification;
import com.wilzwert.myjobs.infrastructure.persistence.mongo.exception.UnsupportedDomainCriterionException;
import lombok.extern.slf4j.Slf4j;
import org.bson.Document;
import org.springframework.data.domain.Sort;
import org.springframework.data.mongodb.core.aggregation.*;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.stereotype.Service;

import java.util.*;
import java.util.function.Function;

/**
 * @author Wilhelm Zwertvaegher
 * This converter should convert DomainSpecification types to Aggregation.Operation types
 */

@Service
<span class="fc" id="L24">@Slf4j</span>
<span class="fc" id="L25">public class DomainSpecificationConverter {</span>

    // provide a field values builder based on target class
<span class="fc" id="L28">    private static final Map&lt;Class&lt;?&gt;, Function&lt;DomainSpecification.FieldSpecificationWithValuesList&lt;?&gt;, List&lt;?&gt;&gt;&gt; valuesClassMap = Map.of(</span>
<span class="fc" id="L29">        UserId.class, spec -&gt; spec.getValues().stream().map(u -&gt; ((UserId) u).value()).toList(),</span>
<span class="fc" id="L30">        JobId.class, spec -&gt; spec.getValues().stream().map(u -&gt; ((JobId) u).value()).toList()</span>
    );

    // provide a field value builder based on target class
<span class="fc" id="L34">    private static final Map&lt;Class&lt;?&gt;, Function&lt;DomainSpecification.FieldSpecificationWithSingleValue&lt;?&gt;, ?&gt;&gt; valueClassMap = Map.of(</span>
<span class="fc" id="L35">            UserId.class, spec -&gt; ((UserId) spec.getValue()).value(),</span>
<span class="nc" id="L36">            JobId.class, spec -&gt; ((JobId) spec.getValue()).value()</span>
    );

    public List&lt;AggregationOperation&gt; convert(DomainSpecification specifications) {
<span class="pc bpc" id="L40" title="1 of 2 branches missed.">        if (specifications == null) {</span>
<span class="nc" id="L41">            return Collections.emptyList();</span>
        }
<span class="fc" id="L43">        return domainSpecificationToAggregationOperation(specifications);</span>
    }

    public String convertField(String field) {
<span class="fc bfc" id="L47" title="All 2 branches covered.">        if(&quot;id&quot;.equals(field)) {</span>
<span class="fc" id="L48">            return &quot;_id&quot;;</span>
        }
<span class="fc" id="L50">        return field.replaceAll(&quot;([a-z])([A-Z]+)&quot;, &quot;$1_$2&quot;).toLowerCase();</span>
    }

    private &lt;S extends DomainSpecification.FieldSpecificationWithSingleValue&lt;V&gt;, V&gt; Object convertValue(S spec) {
<span class="fc" id="L54">        Function&lt;DomainSpecification.FieldSpecificationWithSingleValue&lt;?&gt;, ?&gt; function = valueClassMap.get(spec.getValueClass());</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">        if(function == null) {</span>
<span class="fc" id="L56">            return spec.getValue();</span>
        }
<span class="fc" id="L58">        return function.apply(spec);</span>

    }

    private &lt;S extends DomainSpecification.FieldSpecificationWithValuesList&lt;V&gt;, V&gt; List&lt;?&gt; convertValues(S spec) {
<span class="fc" id="L63">        Function&lt;DomainSpecification.FieldSpecificationWithValuesList&lt;?&gt;, List&lt;?&gt;&gt; function = valuesClassMap.get(spec.getValueClass());</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if(function == null) {</span>
<span class="fc" id="L65">            return spec.getValues();</span>
        }
<span class="fc" id="L67">        return function.apply(spec);</span>
    }

    /**
     *
     * @param domainSpecification a query criterion received from the domain
     * @return a MongoDb Criteria
     */
    public Criteria domainCriterionToCriteria(DomainSpecification domainSpecification) {
<span class="fc" id="L76">        log.debug(&quot;Getting domainCriterionToCriteria of class {}&quot;, domainSpecification.getClass());</span>
<span class="pc bpc" id="L77" title="1 of 7 branches missed.">        switch (domainSpecification) {</span>
<span class="fc" id="L78">            case DomainSpecification.Eq&lt;?&gt; c -&gt; {</span>
<span class="fc" id="L79">                log.debug(&quot;criteria is EQ for {}&quot;, c.getField());</span>
<span class="fc" id="L80">                return Criteria.where(convertField(c.getField())).is(convertValue(c));</span>
            }
<span class="fc" id="L82">            case DomainSpecification.In&lt;?&gt; c -&gt; {</span>
<span class="fc" id="L83">                log.debug(&quot;criteria is In for {}&quot;, c.getField());</span>
<span class="fc" id="L84">                log.debug(&quot;values {}&quot;, c.getValues());</span>
<span class="fc" id="L85">                return Criteria.where(convertField(c.getField())).in(convertValues(c));</span>
            }
<span class="fc" id="L87">            case DomainSpecification.Lt&lt;?&gt; c -&gt; {</span>
<span class="fc" id="L88">                log.debug(&quot;criteria is Lt for {}&quot;, c.getField());</span>
<span class="fc" id="L89">                return Criteria.where(convertField(c.getField())).lt(convertValue(c));</span>
            }
<span class="nc" id="L91">            case DomainSpecification.Or c -&gt; {</span>
<span class="nc" id="L92">                log.debug(&quot;criteria is Or&quot;);</span>
<span class="nc" id="L93">                return new Criteria().orOperator(c.getSpecifications().stream().map(this::domainCriterionToCriteria).toList());</span>
            }
<span class="fc" id="L95">            case DomainSpecification.And c -&gt; {</span>
<span class="fc" id="L96">                log.debug(&quot;criteria is And&quot;);</span>
<span class="fc" id="L97">                return new Criteria().andOperator(c.getSpecifications().stream().map(this::domainCriterionToCriteria).toList());</span>
            }
<span class="fc" id="L99">            case DomainSpecification.MatchQuerySpecification&lt;?&gt; m -&gt; {</span>
<span class="fc" id="L100">                log.debug(&quot;criteria is MatchQuerySpecification&quot;);</span>
<span class="fc" id="L101">                return Criteria.where(&quot;$text&quot;).is(new Document(&quot;$search&quot;, m.getQuery()));</span>
            }
<span class="fc" id="L103">            default -&gt; throw new UnsupportedDomainCriterionException(domainSpecification.getClass().getName());</span>
        }
    }

    private AggregationOperation domainSpecificationSortToAggregationOperation(DomainSpecification.Sort sort) {
<span class="fc bfc" id="L108" title="All 2 branches covered.">        return Aggregation.sort(sort.getSortDirection().equals(DomainSpecification.SortDirection.ASC) ? Sort.Direction.ASC : Sort.Direction.DESC, convertField(sort.getFieldName()));</span>
    }

    /**
     *
     * @param domainSpecification a spec received from the domain
     * @return a List or AggregationOperation (match, lookup, sort...) to be used in an Aggregation pipeline
     */
    public  List&lt;AggregationOperation&gt; domainSpecificationToAggregationOperation(DomainSpecification domainSpecification) {
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if(domainSpecification instanceof DomainSpecification.Sort sort) {</span>
<span class="nc" id="L118">            return List.of(domainSpecificationSortToAggregationOperation(sort));</span>
        }

        List&lt;AggregationOperation&gt; result;

<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (Objects.requireNonNull(domainSpecification) instanceof DomainSpecification.FullSpecification fullSpecification) {</span>
<span class="fc" id="L124">            result = domainSpecificationToAggregationOperation(fullSpecification);</span>
        } else {
<span class="fc" id="L126">            result = new ArrayList&lt;&gt;(List.of(Aggregation.match(domainCriterionToCriteria(domainSpecification))));</span>
        }

<span class="fc" id="L129">        result.addAll(domainSpecification.getSort().stream().map(this::domainSpecificationSortToAggregationOperation).toList());</span>
<span class="fc" id="L130">        return result;</span>
    }

    private List&lt;AggregationOperation&gt; domainSpecificationToAggregationOperation(DomainSpecification.FullSpecification fullDomainSpecification) {
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if(fullDomainSpecification instanceof DomainSpecification.UserJobFollowUpReminderThreshold userJobFollowUpReminderThreshold) {</span>
<span class="nc" id="L135">            return domainSpecificationToAggregationOperation(userJobFollowUpReminderThreshold);</span>
        }

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if(fullDomainSpecification instanceof DomainSpecification.JobFollowUpToRemind jobFollowUpToRemind ) {</span>
<span class="fc" id="L139">            return domainSpecificationToAggregationOperation(jobFollowUpToRemind);</span>
        }

<span class="nc" id="L142">        throw new UnsupportedDomainCriterionException(fullDomainSpecification.getClass().getName());</span>

    }

    /**
     *  This converts a specific Criterion  : users who have not received any job follow-up reminders after
     *  a threshold instant calculated by Mongo, based on provided Instant and user's jobFollowUpReminderDelay
     * @param domainSpecification the Specification received from the domain
     * @return a List or AggregationOperation to be used in an Aggregation pipeline
     */
    public List&lt;AggregationOperation&gt; domainSpecificationToAggregationOperation(DomainSpecification.UserJobFollowUpReminderThreshold domainSpecification) {
<span class="nc" id="L153">    return new ArrayList&lt;&gt;(List.of(</span>
<span class="nc" id="L154">                Aggregation.addFields()</span>
<span class="nc" id="L155">                    .addFieldWithValue(</span>
                            &quot;jobFollowUpReminderThreshold&quot;,
<span class="nc" id="L157">                            ArithmeticOperators.Subtract.valueOf(domainSpecification.getReferenceInstant().toEpochMilli()).subtract(</span>
<span class="nc" id="L158">                                    ArithmeticOperators.Multiply.valueOf(</span>
<span class="nc" id="L159">                                            ConditionalOperators.ifNull(&quot;user.jobFollowUpReminderDays&quot;).then(0)</span>
                                    )
<span class="nc" id="L161">                                    .multiplyBy(86400000)</span>
                            )
<span class="nc" id="L163">                    ).build(),</span>
<span class="nc" id="L164">                Aggregation.match(Criteria.where(&quot;jobFollowUpReminderSentAt&quot;).lt(&quot;jobFollowUpReminderThreshold&quot;))</span>
        ));
    }

    /**
     *  This converts a specific Criterion  : active jobs who have not been reminded after
     *  a threshold instant calculated by Mongo, based on provided Instant and user's jobFollowUpReminderDelay
     * @param domainSpecification the Specification received from the domain
     * @return a List or AggregationOperation to be used in an Aggregation pipeline
     */
    public List&lt;AggregationOperation&gt; domainSpecificationToAggregationOperation(DomainSpecification.JobFollowUpToRemind domainSpecification) {
<span class="fc" id="L175">        List&lt;AggregationOperation&gt; aggregationOperations = new ArrayList&lt;&gt;();</span>
        // filter by status
<span class="fc" id="L177">        aggregationOperations.add(Aggregation.match(Criteria.where(&quot;status&quot;).in(JobStatus.activeStatuses())));</span>

        // lookup users collection
<span class="fc" id="L180">        aggregationOperations.add(Aggregation.lookup().from(&quot;users&quot;).localField(&quot;user_id&quot;).foreignField(&quot;_id&quot;).as(&quot;user&quot;));</span>
        // unwind users
<span class="fc" id="L182">        aggregationOperations.add(Aggregation.unwind(&quot;user&quot;));</span>
        // filter users with no job_follow_up_reminder_days
<span class="fc" id="L184">        aggregationOperations.add(Aggregation.match(Criteria.where(&quot;user.job_follow_up_reminder_days&quot;).exists(true).ne(null)));</span>

        // compute 'thresholdDate' based on provided instant and user.jobFollowUpReminderDelay
<span class="fc" id="L187">        String thresholdField = &quot;job_follow_up_reminder_threshold&quot;;</span>
<span class="fc" id="L188">        aggregationOperations.add( Aggregation.addFields()</span>
<span class="fc" id="L189">                .addFieldWithValue(</span>
                        thresholdField,
<span class="fc" id="L191">                        ArithmeticOperators.Subtract.valueOf(domainSpecification.getReferenceInstant().toEpochMilli()).subtract(</span>
<span class="fc" id="L192">                                ArithmeticOperators.Multiply.valueOf(&quot;user.job_follow_up_reminder_days&quot;)</span>
<span class="fc" id="L193">                                        .multiplyBy(86400000)</span>
                        )
<span class="fc" id="L195">                ).build());</span>

        // convert job's updatedAt Instant to a long (in millis)
<span class="fc" id="L198">        aggregationOperations.add(Aggregation.addFields()</span>
<span class="fc" id="L199">                .addFieldWithValue(&quot;updated_at_millis&quot;, ConvertOperators.ToLong.toLong(&quot;$updated_at&quot;)).build());</span>

        // filter by updatedAt (or statusUpdatedAt ?) &lt; threshold
<span class="fc" id="L202">        aggregationOperations.add(Aggregation.match(</span>
<span class="fc" id="L203">                Criteria.expr(</span>
<span class="fc" id="L204">                    ComparisonOperators.Lte.valueOf(&quot;updated_at_millis&quot;).lessThanEqualTo(thresholdField))</span>
        ));

        // convert job's followUpReminderSentAt Instant to a long (in millis)
<span class="fc" id="L208">        aggregationOperations.add(</span>
<span class="fc" id="L209">            Aggregation.addFields()</span>
<span class="fc" id="L210">                .addFieldWithValue(</span>
                    &quot;job_follow_up_reminder_sent_at_millis&quot;,
<span class="fc" id="L212">                        ConvertOperators.ToLong.toLong(</span>
<span class="fc" id="L213">                            ConditionalOperators.ifNull(&quot;follow_up_reminder_sent_at&quot;).then(0)</span>
                        )
<span class="fc" id="L215">            ).build()</span>
        );

        // filter lastReminderSentAt &lt; threshold to avoid multiple reminders
<span class="fc" id="L219">        aggregationOperations.add(Aggregation.match(</span>
<span class="fc" id="L220">                Criteria.expr(</span>
<span class="fc" id="L221">                        ComparisonOperators.Lte.valueOf(&quot;job_follow_up_reminder_sent_at_millis&quot;).lessThanEqualTo(thresholdField))</span>
        ));

<span class="fc" id="L224">        return aggregationOperations;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>